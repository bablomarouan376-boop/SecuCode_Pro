<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecuCode Pro | طارق مصطفى</title>
    <link rel="manifest" href="/manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Cairo', sans-serif; background: #020617; color: white; }
        .glass { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }
    </style>
</head>
<body class="p-6">
    <main class="max-w-4xl mx-auto">
        <header class="flex justify-between items-center mb-10">
            <h1 class="text-4xl font-black italic uppercase">SECUCODE <span class="text-blue-600">PRO</span></h1>
            <button onclick="toggleLang()" id="langBtn" class="bg-blue-600 px-6 py-2 rounded-full font-bold text-xs uppercase">English</button>
        </header>

        <section class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-10">
            <div class="glass p-5 rounded-3xl text-center">
                <span id="label-total" class="text-[10px] text-slate-400 uppercase font-black">إجمالي الفحص</span>
                <p id="totalScanned" class="text-2xl font-black text-blue-500 mt-2">--</p>
            </div>
            <div class="glass p-5 rounded-3xl text-center">
                <span id="label-threats" class="text-[10px] text-slate-400 uppercase font-black">تهديدات محجوبة</span>
                <p id="threatsDetected" class="text-2xl font-black text-red-500 mt-2">--</p>
            </div>
            </section>

        <div class="glass p-4 rounded-[2rem] relative overflow-hidden mb-10">
            <div class="flex flex-col md:flex-row gap-3">
                <input type="url" id="urlInput" placeholder="أدخل الرابط للفحص..." class="w-full bg-transparent p-4 outline-none font-bold">
                <button onclick="startAnalysis()" id="scanBtn" class="bg-blue-600 px-10 py-4 rounded-xl font-black">تحليل</button>
            </div>
        </div>

        <div id="resultsArea" class="hidden"></div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, runTransaction } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = { databaseURL: "https://flutter-ai-playground-2de28-default-rtdb.europe-west1.firebasedatabase.app" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // 1. جلب البيانات الأصلية من قاعدة البيانات فوراً
        const statsRef = ref(db, 'stats');
        onValue(statsRef, (snapshot) => {
            const data = snapshot.val() || { clicks: 0, threats: 0 };
            document.getElementById('totalScanned').innerText = data.clicks.toLocaleString();
            document.getElementById('threatsDetected').innerText = data.threats.toLocaleString();
        });

        // 2. الفحص وتحديث قاعدة البيانات الحقيقية
        window.startAnalysis = async function() {
            const url = document.getElementById('urlInput').value.trim();
            if(!url) return;
            
            try {
                const response = await fetch('/analyze', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ link: url })
                });
                const data = await response.json();

                // تحديث Firebase الحقيقي (مش وهمي)
                runTransaction(ref(db, 'stats/clicks'), (c) => (c || 0) + 1);
                if(data.risk_score === 'Critical') {
                    runTransaction(ref(db, 'stats/threats'), (t) => (t || 0) + 1);
                }

                renderResults(data);
            } catch (e) { console.error(e); }
        }

        // 3. نظام تبديل اللغة (English/Arabic)
        let currentLang = 'ar';
        window.toggleLang = function() {
            currentLang = currentLang === 'ar' ? 'en' : 'ar';
            const isEn = currentLang === 'en';
            
            document.documentElement.dir = isEn ? 'ltr' : 'rtl';
            document.getElementById('langBtn').innerText = isEn ? 'العربية' : 'English';
            document.getElementById('urlInput').placeholder = isEn ? 'Enter link for scan...' : 'أدخل الرابط للفحص...';
            document.getElementById('scanBtn').innerText = isEn ? 'Analyze' : 'تحليل';
            document.getElementById('label-total').innerText = isEn ? 'Total Scans' : 'إجمالي الفحص';
            document.getElementById('label-threats').innerText = isEn ? 'Blocked Threats' : 'تهديدات محجوبة';
        }

        function renderResults(data) {
            const area = document.getElementById('resultsArea');
            area.classList.remove('hidden');
            const color = data.risk_score === 'Critical' ? '#ef4444' : '#22c55e';
            area.innerHTML = `<div class="glass p-10 rounded-[3rem] border-r-[10px]" style="border-color:${color}">
                <h2 class="text-5xl font-black" style="color:${color}">${data.risk_score}</h2>
                <p class="mt-4 text-slate-400">${data.violations[0].desc}</p>
            </div>`;
        }
    </script>
</body>
</html>
